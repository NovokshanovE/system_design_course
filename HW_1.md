# Self-service сервис диагностики флагов для Flagman

## 1. Проблема / задача

Во время работы над продуктом **Flagman** в Яндексе возникала системная проблема:

* при вопросе *«почему флаг не сработал у пользователя?»* разработчиков постоянно отвлекали;
* для диагностики приходилось вручную лезть в разные внутренние системы - MADM, BigB, логи;
* менеджеры и тестировщики не могли самостоятельно проверить гипотезы по флагам;
* анализ занимал много времени, а картина срабатываний была непрозрачной.

**Цель:** создать self-service-инструмент, который по `YandexUID` показывает историю флагов и поясняет логику их срабатывания без участия разработчика.

---

## 2. Требования

### Функциональные требования

* Получение истории всех флагов по `YandexUID`.
* Фильтры по ID флага и по типу события (показ / клик / закрытие).
* Визуализация логики флага в виде графа состояний.
* Интеграции со внутренними системами:

  * Blackbox - авторизация и проверка прав;
  * MADM - загрузка настроек флага;
  * BigB - история фактических срабатываний.

### Нефункциональные требования

* Быстрый ответ: **1-2 секунды**.
* Изоляция от SLA основного Flagman - диагностика не должна влиять на прод.
* Возможность запуска **тестовых окружений на каждый PR**.
* Простое расширение и поддерживаемость.

### Ограничения

* Основной язык команды - **Go**.
* Используется внутренний HTTP-фреймворк **Avocado**.
* Деплой утверждён только во внутреннюю инфраструктуру Яндекса.
* Окружения и CI/CD настраиваются самостоятельно.

---

## 3. Возможные варианты решений

### Вариант 1. Встроить диагностику прямо в основной сервис Flagman

**Плюсы:**

* нет отдельной инфраструктуры;
* проще интегрироваться с существующим кодом.

**Минусы:**

* рост сложности и связности Flagman;
* риск просадки производительности из-за тяжёлых запросов;
* диагностика будет зависеть от релизного цикла основного продукта.

---

### Вариант 2. Набор отдельных CLI-утилит и дашбордов

**Плюсы:**

* быстрое прототипирование;
* минимум серверной логики.

**Минусы:**

* неудобно для менеджеров и тестировщиков;
* сложно контролировать доступы;
* добавить визуализацию или сложную аналитику практически невозможно.

---

### Вариант 3. Отдельный микросервис для диагностики Flagman (выбран)

Самостоятельный сервис, который:

* реализует чистую архитектуру (`domain / application / infrastructure`);
* предоставляет HTTP-API на базе Avocado;
* инкапсулирует интеграции с Blackbox, MADM, BigB;
* имеет собственный web-интерфейс;
* разворачивает собственные окружения: dev / testing / production;
* CI/CD позволяет поднимать стенды для каждого PR.

**Плюсы:**

* независимость от Flagman и отсутствие риска его деградации;
* изоляция ответственности и лёгкость поддерживания;
* можно быстро экспериментировать с UI и внутренней логикой;
* возможность переиспользования другими командами.

**Минусы:**

* требуется больше работы по инфраструктуре и интеграциям.

---

## 4. Почему было принято именно это решение

1. **Изоляция критического пути продукта.**
   Диагностика не должна ломать основной сервис - отдельный микросервис полностью снижает этот риск.

2. **Архитектурная чистота.**
   Благодаря четкому разделению слоёв логика флагов тестируется без завязки на внешние системы, а сами интеграции остаются в инфраструктурном слое.

3. **Удобство для пользователей.**
   Менеджерам нужен интуитивный web-интерфейс, а не набор CLI-утилит.

4. **Гибкость и независимое развитие.**
   Новый функционал - визуализация, «what-if» сценарии, аналитика - можно внедрять без ограничений монолита Flagman.

5. **Ценная практика.**
   Создание сервиса с нуля позволило пройти полный цикл: от проектирования до настройки CI/CD, интеграций и прод-окружений.

---

## 5. Итог

Решением стал **отдельный микросервис диагностики для Flagman**:

* backend на Go с чистой архитектурой;
* собственный web-интерфейс;
* интеграции с Blackbox, MADM и BigB;
* полноценный CI/CD и PR-стенды.

Сервис уменьшил нагрузку на разработчиков, ускорил диагностику и стал удобным инструментом для менеджеров и тестировщиков, при этом не усложняя основной продукт.

